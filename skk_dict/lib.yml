version: 3

tasks:

  download_dict:
    internal: true
    requires:
      vars: [ URL, TMP_DIR ]
    vars:
      TMP_DIR: "{{ .TMP_DIR | default \"./tmp\"}}"
      DST_FILE: "{{ .TMP_DIR }}/{{ osBase .URL }}"
      GUNZIPPED_FILE: "{{ trimSuffix \".gz\" .DST_FILE}}"
      UNTARED_FILE: "{{ trimSuffix \".tar\" .GUNZIPPED_FILE}}"
      UTF8_FILE: "{{ trimSuffix \".utf8\" .UNTARED_FILE }}.utf8"
    cmds:
      - echo "Downloading {{ .DST_FILE | osBase }}" 
      - task: download_file
        vars:
          URL: "{{ .URL }}"
          DST_FILE: "{{ .DST_FILE }}"
      - task: "{{ if hasSuffix \".gz\" .DST_FILE }}gunzip{{ else }}noop{{end}}"
        vars:
          FILE: "{{ .DST_FILE }}"
      - task: "{{ if hasSuffix \".tar\" .GUNZIPPED_FILE }}untar{{ else }}noop{{end}}"
        vars:
          SRC_FILE: "{{ .GUNZIPPED_FILE }}"
          FILE: "{{ .UNTARED_FILE | osBase }}"
      - task: "{{ if hasSuffix \".utf8\" .UNTARED_FILE }}noop{{ else }}convert_to_utf8{{ end }}"
        vars:
          SRC_FILE: "{{ .UNTARED_FILE }}"
          DST_FILE: "{{ .UTF8_FILE }}"
      - task: verify_candidates
        vars:
          FILE1: "{{ .UNTARED_FILE }}"
          FILE2: "{{ .UTF8_FILE }}"

  gunzip:
    internal: true
    requires:
      vars: [ FILE ]
    cmds:
      - gunzip "{{ .FILE }}"

  untar:
    internal: true
    requires:
      vars: [ SRC_FILE, FILE ]
    cmds:
      - tar xf "{{ .SRC_FILE }}" -C "{{ .SRC_FILE | osDir }}" "{{ .FILE }}"

  download_file:
    internal: true
    requires:
      vars: [ URL, DST_FILE ]
    cmds:
      - curl -sL --fail "{{ .URL }}" > "{{ .DST_FILE }}"

  convert_to_utf8:
    internal: true
    requires:
      vars: [ SRC_FILE, DST_FILE ]
    cmds:
      - piconv -f euc-jp -t utf-8 < "{{ .SRC_FILE }}" > "{{ .DST_FILE }}"

  verify_candidates:
    internal: true
    requires:
      vars: [FILE1, FILE2]
    cmds:
      - |
        RED='\033[0;31m'
        NC='\033[0m'
        COUNT1=$(skkdic-count {{ .FILE1 }} | awk '{ print $2 }')
        COUNT2=$(skkdic-count {{ .FILE2 }} | awk '{ print $2 }')
        if [ "$COUNT1" != "$COUNT2" ]; then
          echo -e "${RED}The candidates were lost in encoding change ($COUNT1 -> $COUNT2).${NC}"
        fi
        if [ "$COUNT2" = "0" ]; then
          echo -e "${RED}Dictionary is empty.${NC}"
        fi

  noop:
    internal: true
    cmds:
